/**
 * This is the binding file to add the jquery-multi-list custom widget to the struts2.jquery.ui framework
 */

/**   Usage
 
   See:  http://people.iola.dk/olau/flot/API.txt
 */

(function($){Struts2jQuery.widget("chart",function($elem,options){var loadHandlerName='_struts2_jquery_chart_load';Struts2jQuery.base($elem,options);Struts2jQuery.container($elem,options,loadHandlerName);if($.plot){var flotOptions={};if(options){if(options.colors){flotOptions.colors=options.colors.split(',');};flotOptions.grid={show:options.grid,color:options.gridcolor,backgroundColor:options.gridbackground,tickColor:options.tickcolor,borderWidth:options.borderwidth};if(options.onplotclicktopic&&options.onplotclicktopic.length>0){flotOptions.grid.clickable=true;elem.publishOnEvent('plotclick',onplotclicktopic);};if(options.onplothovertopic&&options.onplothovertopic.length>0){flotOptions.grid.hoverable=true;elem.publishOnEvent('plothover',onplothovertopic);};flotOptions.series={lines:{show:options.line=="true"},points:{show:options.point=="true"},bars:{show:options.bar=="true"},pie:{show:options.pie=="true"},stack:{show:options.stacked=="true"}};flotOptions.legend={position:options.legendposition||"se",show:options.showlegend=="true",backgroundColor:options.legendcolor,backgroundOpacity:options.legendopacity};flotOptions.xaxis={mode:options.xaxis1time?"time":null,min:options.xaxis1min?options.xaxis1min:null,max:options.xaxis1max?options.xaxis1max:null};flotOptions.yaxis={mode:options.yaxis1time?"time":null,min:options.yaxis1min?options.yaxis1min:null,max:options.yaxis1max?options.yaxis1max:null};flotOptions.x2axis={mode:options.xaxis2time?"time":null,min:options.xaxis2min?options.xaxis2min:null,max:options.xaxis2max?options.xaxis2max:null};flotOptions.y2axis={mode:options.yaxis2time?"time":null,min:options.yaxis2min?options.yaxis2min:null,max:options.yaxis2max?options.yaxis2max:null};var data=eval(options.data)||[];var lines=options.lines?options.lines.split(','):[];var points=options.points?options.points.split(','):[];var bars=options.bars?options.bars.split(','):[];var labels=options.labels?options.labels.split(','):[];var seriesClickTopics=options.seriesclicktopics?options.seriesclicktopics.split(','):[];var seriesHoverTopics=options.serieshovertopics?options.serieshovertopics.split(','):[];for(i=0;i<data.length;i++){var series=data[i];if(labels.length>i){series.label=labels[i];}
if(lines.length>i&&lines[i]=="true"){series.lines={show:true};}
if(points.length>i&&points[i]=="true"){series.points={show:true};}
if(bars.length>i&&bars[i]=="true"){series.bars={show:true};}
if(seriesClickTopics.length>i){series.clickable=true;elem.publishOnEvent('plotclick',seriesClickTopics[i]);}
if(seriesHoverTopics.length>i){series.hoverable=true;elem.publishOnEvent('plothover',seriesHoverTopics[i]);}}
flotOptions.src=options.src;flotOptions.pollmillis=options.pollmillis;if(options.options){var userOptionsStr=options.options;var userOptions=window[userOptionsStr];if(!userOptions){userOptions=eval("( "+userOptionsStr+" )");}
$.extend(flotOptions,userOptions);}}
if(!($elem[0].height||$elem[0].style.height)){$elem.css('height',$elem.parent().height());}
if(!($elem[0].width||$elem[0].style.width)){$elem.css('width','auto');}
$.plot($elem,data,flotOptions);if(flotOptions.src){$elem.trigger('_struts2_jquery_trigger_fetch',[flotOptions,loadHandlerName]);}}else{$elem.text("Struts2-JQuery charting is not enabled. Set the chartingEnabled='true' attribute in the head tag first.");}});$.subscribeHandler('_struts2_jquery_chart_load',function(event,data){var chart=$(event.target);var attributes=chart[0].attributes;var options={};for(var i=0;i<attributes.length;i++){options[attributes[i].name.toLowerCase()]=attributes[i].value;}
$.extend(options,event.data);if(data&&!data.id){$.extend(options,data);}
var isDisabled=false;isDisabled=options.disabled==null?isDisabled:options.disabled;isDisabled=chart.attr('disabled')==null?isDisabled:chart.attr('disabled');if(event.originalEvent){isDisabled=$(event.originalEvent.currentTarget).attr("disabled")==null?isDisabled:$(event.originalEvent.currentTarget).attr("disabled");}
if(isDisabled!=true&&isDisabled!='true'){var indicatorId=options.indicatorid;if(indicatorId){$('#'+indicatorId).show();}
if(options.loadingtext){chart.html(options.loadingtext);}
var onAlwaysTopics=options.onalwaystopics;if(onAlwaysTopics){var topics=onAlwaysTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],chart);}}
if(options.onbeforetopics){var topics=options.onbeforetopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],chart);}}
var onSuccessTopics=options.onsuccesstopics;options.success=function(data,textStatus){chart.data('loaded',true);if(indicatorId){$('#'+indicatorId).hide();}
if(typeof(data)=="object"||$.isArray(data)){if(typeof(data)=="object"){for(i in data){var series=data[i];if(series&&typeof(series.data)=="object"){var seriesData=series.data;var seriesDataArray=[];for(x in seriesData){seriesDataArray.push([x,seriesData[x]]);}
series.data=seriesDataArray;}}}
$.plot(chart,data,options);}
if(onSuccessTopics){var topics=onSuccessTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],chart);}}
if(onAlwaysTopics){var topics=onAlwaysTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],chart);}}};var onCompleteTopics=options.oncompletetopics;options.complete=function(xhr,textStatus,errorThrown){if(indicatorId){$('#'+indicatorId).hide();}
if(xhr.status==404){chart.html(xhr.responseText);}
if(onCompleteTopics){var topics=onCompleteTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],container);}}
if(onAlwaysTopics){var topics=onAlwaysTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],container);}}};var onErrorTopics=options.onerrortopics;options.error=function(XMLHttpRequest,textStatus,errorThrown){if(options.errortext){chart.html(options.errortext);}
if(onErrorTopics){var topics=onErrorTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],container);}}
if(onAlwaysTopics){var topics=onAlwaysTopics.split(',');for(var i=0;i<topics.length;i++){chart.publish(topics[i],container);}}};var serializeData;var formIds=options.formids;if(formIds){var forms=formIds.split(',');for(var i=0;i<forms.length;i++){serializeData=(serializeData?(serializeData+"&"):"")+$("#"+forms[i]).serialize();}};var elementIds=options.elementids;if(elementIds){var elements=elementIds.split(',');for(var i=0;i<elements.length;i++){var element=$('#'+elements[i])[0];if(element&&element.name){serializeData=(serializeData?(serializeData+"&"):"")+element.name+"="+element.value;}}};if(serializeData&&options.validate){serializeData['struts.enableJSONValidation']=true;};$.extend(options,{data:serializeData});if(options.reloadtopics){var topics=options.reloadtopics.split(',');for(var i=0;i<topics.length;i++){chart.unsubscribe(topics[i]);chart.subscribe(topics[i],'_struts2_jquery_chart_load',options);}};if(options.src){options.type="POST";options.url=options.src;options.dataType="json";if(!options.data){options.data={};}
$.ajax(options);};}});})(jQuery);